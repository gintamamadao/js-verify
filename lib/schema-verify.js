"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const r=r=>null!=r&&"object"==typeof r&&!1===Array.isArray(r),e=r=>"[object Array]"==Object.prototype.toString.call(r),t=r=>"string"==typeof r,n=r=>"number"==typeof r&&!Number.isNaN(r)&&(r=>r!==1/0&&r!==-1/0)(r),i=r=>n(r)&&Math.floor(r)===r,o=r=>"function"==typeof r,s=r=>null===r,a=r=>void 0===r,c=r=>null==r,f={string:{is:r=>t(r),isNot:r=>!t(r),isEmpty:r=>t(r)&&0===r.length,isNotEmpty:r=>t(r)&&r.length>=1,safe:r=>t(r)?r:c(r)?"":r+""},number:{is:r=>n(r),isNot:r=>!n(r),isInteger:r=>n(r)&&i(r),isNatural:r=>n(r)&&i(r)&&r>=0,safe:r=>n(r)?r:c(r)?0:(r=new Number(r).valueOf(),n(r)?r:0)},boolean:{is:r=>!0===r||!1===r,isNot:r=>!0!==r&&!1!==r},array:{is:r=>e(r),isNot:r=>!e(r),isEmpty:r=>e(r)&&0===r.length,isNotEmpty:r=>e(r)&&r.length>=1,safe:r=>e(r)?r:[],pure(r){if(!e(r))return[];const t=[];return r.forEach(r=>{c(r)||t.push(r)}),t}},object:{is:e=>r(e),isNot:e=>!r(e),isEmpty:e=>r(e)&&0===Object.keys(e).length,isNotEmpty:e=>r(e)&&Object.keys(e).length>=1,safe:e=>r(e)?e:{},pure(e){if(!r(e))return{};const t=Object.assign({},e);return Object.keys(t).forEach(r=>{c(t[r])&&delete t[r]}),t}},func:{is:r=>o(r),isNot:r=>!o(r),safe:(r,e)=>function(){if(o(r))return e=e||s(e)?e:this,r.apply(e,Array.prototype.slice.apply(arguments))}},undefinedNull:{is:r=>c(r),isNot:r=>!c(r)},nul:{is:r=>s(r),isNot:r=>!s(r)},undefined:{is:r=>a(r),isNot:r=>!a(r)}},l=new RegExp(/^1\d{10}$/),y=new RegExp(/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/),u=new RegExp(/(^#\w{3}$)|(^#\w{6}$)|(^rgb\s*\((\s*\d{1,3}\s*,){2}\s*\d{1,3}\s*\)$)|(^rgba\s*\((\s*\d{1,3}\s*,){3},[01]{1}\.?\d*\s*\)$)/),p=new RegExp(/(^[vV]\d+$)|(^[vV]((\d+\.)+)(\d+)$)/),m=new RegExp(/^[a-zA-Z_][a-zA-Z_\d]*$/),h=new RegExp(/^\d+$/),b=new RegExp(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(:\d{2})?/),w={phone:{is:r=>f.string.isNotEmpty(r)&&l.test(r)},uri:{is(r){try{return f.string.isNotEmpty(r)&&f.object.is(new URL(r))}catch(r){return!1}}},email:{is:r=>f.string.isNotEmpty(r)&&y.test(r)},color:{is:r=>f.string.isNotEmpty(r)&&u.test(r)},version:{is:r=>f.string.isNotEmpty(r)&&p.test(r)},sign:{is:r=>f.string.isNotEmpty(r)&&m.test(r)},numStr:{is:r=>f.string.isNotEmpty(r)&&h.test(r)},jsonStr:{is(r){try{return f.string.isNotEmpty(r)&&JSON.parse(r)}catch(r){return!1}}},time:{is(r){const e=new Date(r);return f.object.is(e)&&"Invalid Date"!==e.toString()},isCommon:r=>f.string.isNotEmpty(r)&&b.test(r)}};class E{safeErrorHint(r){return"string"==typeof r?r:r&&r.message?r.message:"未知"}}var g=new class extends E{constructor(){super(),this.propEmptyHint="对象缺少属性",this.elementEmptyHint="数组缺少元素",this.propErrorHint=(r,e)=>`属性 ${r}: ${this.safeErrorHint(e)}`,this.elementErrorHint=(r,e)=>`第 ${r} 项: ${this.safeErrorHint(e)}`}minValueHint(r){return"小于最小值 "+r}maxValueHint(r){return"大于最大值 "+r}minLenHint(r){return"小于最小长度 "+r}maxLenHint(r){return"大于最大长度 "+r}typeNeedHint(r){return`需要 ${r} 类型`}enumHint(r){return r+" 不是有效值之一"}integerHint(r){return r+" 不是整数"}naturalHint(r){return r+" 不是自然数"}matchHint(r){return r+" 未通过正则规则"}patternNeedHint(r){return`需要 ${r} 格式`}propNeedHint(r){return`属性 ${r}: 缺少数据`}propRestrictHint(r){return`属性 ${r} 不允许`}elementNeedHint(r){return`第 ${r} 项: 缺少数据`}verifyErrorHint(r,e,t){return`${r?r+" ":""}校验不通过, 错误信息：${e||t||"未知"}`}};const N={string:"string",number:"number",object:"object",array:"array",function:"function",boolean:"boolean",null:"null"},d="index",j="required",H="type",O="schema",P="custom",x="hint",k="pattern",v="length",$="minLength",I="maxLength",V="min",_="max",R="enum",L="match",A="range",S="integer",T="natural",F="restrict",M="props",q="elements",z=[d,j,H,O,P,x],D={string:[k,v,R,L,$,I],number:[A,S,T,R,V,_],object:[F,M],array:[q,v,$,I],function:[],boolean:[],null:[]},Z=z.slice(0,z.length-2),U=(r,e,t)=>{let n=!1;switch(e){case N.string:n=f.string.is(r);break;case N.number:n=f.number.is(r);break;case N.object:n=f.object.is(r);break;case N.array:n=f.array.is(r);break;case N.function:n=f.func.is(r);break;case N.boolean:n=f.boolean.is(r);break;case N.null:n=f.nul.is(r)}if(!n)throw new Error(g.verifyErrorHint(H,t,g.typeNeedHint(e)));return!0},C=(r,e,t,n)=>{if(!e)return!0;const i=Object.keys(r);let o=[];for(const r of t)f.object.is(r)&&o.push(r.index),f.array.is(r)&&o.push(r[0].index);o=o.filter(r=>r);for(const r of i)if(!o.includes(r))throw new Error(g.verifyErrorHint(F,n,g.propRestrictHint(r)));return!0},B=(r,e,t)=>{const n=(w[e]||{}).is;if(!("function"==typeof n&&n.call(w[e],r)))throw new Error(g.verifyErrorHint(k,t,g.patternNeedHint(e)));return!0},J=(r,e,t)=>{const n=e.min,i=e.max,o=r.length;if(f.number.is(n)&&n>o)throw new Error(g.verifyErrorHint(v,t,g.minLenHint(n)));if(f.number.is(i)&&o>i)throw new Error(g.verifyErrorHint(v,t,g.maxLenHint(i)));return!0},G=(r,e,t)=>{if(!e.includes(r))throw new Error(g.verifyErrorHint(R,t,g.enumHint(r)));return!0},K=(r,e,t)=>{if(e&&!f.number.isInteger(r))throw new Error(g.verifyErrorHint(S,t,g.integerHint(r)));return!0},Q=(r,e,t)=>{if(e&&!f.number.isNatural(r))throw new Error(g.verifyErrorHint(T,t,g.naturalHint(r)));return!0},W=(r,e,t)=>{if(f.string.is(e)&&(e=new RegExp(e)),!e.test(r))throw new Error(g.verifyErrorHint(L,t,g.matchHint(r)));return!0},X=(r,e,t)=>{const n=e.min,i=e.max;if(f.number.is(n)&&n>r)throw new Error(g.verifyErrorHint(A,t,g.minValueHint(n)));if(f.number.is(i)&&r>i)throw new Error(g.verifyErrorHint(A,t,g.maxValueHint(i)));return!0},Y=(r,e,t)=>{const n=(e,n,i)=>{let o,s;if(f.array.isNotEmpty(n)){const r=n[0];o=r.required,s=f.object.safe(r.hint)}else o=n.required,s=f.object.safe(n.hint);const a=s[j]||(t===N.object?g.propNeedHint:g.elementNeedHint)(i);if(!((r,e,t,n)=>{if(f.object.is(r)&&!r.hasOwnProperty(e)||f.array.is(r)&&f.undefined.is(r[e])){if(t)throw new Error(n);return!0}return!1})(r,i,o,a))try{nr(e,n,r)}catch(r){throw new Error((t===N.object?g.propErrorHint:g.elementErrorHint)(i,r))}},i=(e,i)=>{let o,s;if(f.array.isNotEmpty(e)){const r=e[0];o=r.required,s=f.object.safe(r.hint)}else o=e.required,s=f.object.safe(e.hint);const a=t===N.object?Object.keys(r):Array.from("a".repeat(r.length)).map((r,e)=>e);if(o&&0>=a.length)throw new Error(s[j]||(t===N.object?g.propEmptyHint:g.elementEmptyHint));for(let t of a)if(!i[t]){n(r[t],e,t),i[t]=!0}};try{(e=>{const t={};for(const o of e){let e;if(f.array.isNotEmpty(o)){e=o[0].index}else e=o.index;if(f.number.isNatural(e)||f.string.isNotEmpty(e)){n(r[e],o,e),t[e]=!0}else i(o,t)}})(e)}catch(r){throw r}},rr=(r,e,t,n)=>{try{e.verify(r,!0,n)}catch(r){throw new Error(g.verifyErrorHint(O,t||""+g.safeErrorHint(r)))}return!0},er=(r,e,t,n)=>{try{if(!f.func.safe(e)(r,n))throw new Error(t||"未知")}catch(r){throw new Error(g.verifyErrorHint(P,""+g.safeErrorHint(r)))}return!0},tr=(r,e,t)=>{try{(()=>{const n=f.object.safe(e.hint),i=e.type,o=[].concat(Z,D[i]);o.push(P);for(const s of o){if(!e.hasOwnProperty(s))continue;const o=e[s],a=e.props,c=n[s];switch(s){case H:U(r,o,c);break;case F:C(r,o,a,c);break;case k:B(r,o,c);break;case v:J(r,o,c);break;case R:G(r,o,c);break;case L:W(r,o,c);break;case A:X(r,o,c);break;case S:K(r,o,c);break;case T:Q(r,o,c);break;case q:case M:Y(r,o,i);break;case O:rr(r,o,c,t);break;case P:er(r,o,c,t)}}})()}catch(r){throw r}},nr=(r,e,t)=>{const n=e=>{try{tr(r,e,t)}catch(r){throw r}};if(f.object.is(e)&&n(e),f.array.is(e)){const r=[];for(let t=0;e.length>t;t++)try{n(e[t]);break}catch(e){r.push(`schema-${t}: ${g.safeErrorHint(e)}`)}if(e.length===r.length)throw new Error(r.join(";"))}return!0};var ir=new class extends E{constructor(){super(),this.propsInfoEmpty="属性信息不能为空",this.emptyLengthInfo="空的长度信息",this.emptyEnumInfo="空的枚举信息",this.errorEnumInfo="错误的枚举信息",this.emptyHintInfo="空的提示信息",this.emptyRangeInfo="空的范围信息"}unIdentifyType(r){return"不可识别的属性类型："+r}illegalHintInfo(r){return"非法的提示信息属性："+r}illegalVerifyProps(r){return"非法的校验属性："+r}illegalPatternType(r){return"非法的格式类型："+r}};const or=Object.keys(w),sr=r=>{let e=r[v];if(!f.object.isNotEmpty(e)&&!f.number.isNatural(e))throw new Error(ir.emptyLengthInfo);if(f.number.isNatural(e))r[v]={min:e,max:e};else if(f.object.isNotEmpty(e)){if(!f.number.isNatural(e.min)&&!f.number.isNatural(e.max))throw new Error(ir.emptyLengthInfo);f.number.isNatural(e.min)||delete e.min,f.number.isNatural(e.max)||delete e.max}},ar=(r,e)=>{const t=r[R];let n;if(f.object.isNotEmpty(t)&&(n=Object.keys(t).map(r=>t[r])),f.array.isNotEmpty(t)&&(n=t),!f.array.isNotEmpty(n))throw new Error(ir.emptyEnumInfo);const i=n.every(r=>f.number.is(r)),o=n.every(r=>f.string.is(r));if(!i&&e)throw new Error(ir.errorEnumInfo);if(!o&&!e)throw new Error(ir.errorEnumInfo);r[R]=n},cr=r=>{if(r.hasOwnProperty($)){const e=r[$];if(f.number.isNatural(e)){let t=r[v];const n={min:e};r[v]=f.object.is(t)?Object.assign({},t,n):n,delete r[$]}}if(r.hasOwnProperty(I)){const e=r[I];if(f.number.isNatural(e)){let t=r[v];const n={max:e};r[v]=f.object.is(t)?Object.assign({},t,n):n,delete r[I]}}},fr=r=>{if(f.object.isNot(r)&&!f.array.isNotEmpty(r))throw new Error(ir.propsInfoEmpty);if(f.array.is(r)){const e=[];for(let t=0;r.length>t;t++)e[t]=fr(r[t]);return e}if(r instanceof br&&(r={schema:r}),r.hasOwnProperty(O)){const e=r[O];if(f.object.isNot(e)||!(e instanceof br))throw new Error(ir.illegalVerifyProps(O));const t=e.info;for(const e of[H,j,d])!r.hasOwnProperty(e)&&t.hasOwnProperty(e)&&(r[e]=t[e])}const e=Object.assign({},r);return lr(e)},lr=r=>{switch(r.type){case N.string:case String:(r=ur(r)).type=N.string;break;case N.number:case Number:(r=pr(r)).type=N.number;break;case N.object:case Object:(r=mr(r)).type=N.object;break;case N.array:case Array:(r=hr(r)).type=N.array;break;case N.function:case Function:r.type=N.function;break;case N.boolean:case Boolean:r.type=N.boolean;break;case N.null:case null:r.type=N.null}return yr(r)},yr=r=>{const e=D[r.type];if(f.array.isNot(e))throw new Error(ir.unIdentifyType(e));for(const t of Object.keys(r))if(!z.includes(t)&&!e.includes(t))throw new Error(ir.illegalVerifyProps(t));if(r.hasOwnProperty(x)){const t=r[x];if(!f.object.is(t))throw new Error(ir.illegalVerifyProps(x));for(const r of Object.keys(t))if(!z.includes(r)&&!e.includes(r))throw new Error(ir.illegalHintInfo(r))}if(r.hasOwnProperty(P)){if(f.func.isNot(r[P]))throw new Error(ir.illegalVerifyProps(P))}if(r.hasOwnProperty(d)){const e=r[d];if(f.string.isNot(e)&&f.number.isNot(e))throw new Error(ir.illegalVerifyProps(d))}return r},ur=r=>{if(r.hasOwnProperty(k)){const e=r[k];if(!or.includes(e))throw new Error(ir.illegalPatternType(e))}if(cr(r),r.hasOwnProperty(v)&&sr(r),r.hasOwnProperty(R)&&ar(r),r.hasOwnProperty(L)){const e=r[L];if(!(f.string.isNotEmpty(e)||e instanceof RegExp))throw new Error(ir.illegalVerifyProps(L))}return r},pr=r=>{if(r.hasOwnProperty(V)){const e=r[V];if(f.number.isNatural(e)){let t=r[A];const n={min:e};r[A]=f.object.is(t)?Object.assign({},t,n):n,delete r[V]}}if(r.hasOwnProperty(_)){const e=r[_];if(f.number.isNatural(e)){let t=r[A];const n={max:e};r[A]=f.object.is(t)?Object.assign({},t,n):n,delete r[_]}}if(r.hasOwnProperty(A)){const e=r[A];if(f.object.isEmpty(e))throw new Error(ir.emptyRangeInfo);if(f.number.isNot(e.min)&&f.number.isNot(e.max))throw new Error(ir.emptyRangeInfo);e.min=+e.min,e.max=+e.max}if(r.hasOwnProperty(S)){if(f.boolean.isNot(r[S]))throw new Error(ir.illegalVerifyProps(S))}if(r.hasOwnProperty(T)){if(f.boolean.isNot(r[T]))throw new Error(ir.illegalVerifyProps(T))}return r.hasOwnProperty(R)&&ar(r,!0),r},mr=r=>{if(r.hasOwnProperty(M)){const e=r[M];if(!f.object.isNotEmpty(e)&&!f.array.is(e))throw new Error(ir.illegalVerifyProps(M));const t=(r,e)=>{!(f.func.isNot(r[H])&&f.nul.isNot(r[H])&&f.string.isNot(N[r[H]]))||r.hasOwnProperty(O)||r instanceof br?(delete r[d],e.props=[fr(r)]):(r=Object.keys(r).map(e=>{const t=r[e];return"$_PROPS_DEFAULT_INFO"===e||(f.object.is(t)&&(t[d]=e),f.array.is(t)&&f.object.is(t[0])&&(t[0][d]=e)),t}),n(r,e))},n=(r,e)=>{const t=r.reduce((r,e)=>{let t;if(f.object.is(e)&&e.hasOwnProperty(d)&&(t=e[d],!f.string.isNotEmpty(t)&&!f.number.is(t)))throw new Error(ir.illegalVerifyProps(d));return f.array.is(e)&&f.object.is(e[0])&&(t=e[0][d],f.string.isNotEmpty(t)||delete e[0][d]),f.string.isNotEmpty(t)||(t="$_PROPS_ELEMENTS_DEFAULT_SCHEME_INFO"),r[t]=fr(e),r},{});e[M]=Object.keys(t).map(r=>t[r])};f.object.isNotEmpty(e)?t(e,r):n(e,r)}if(r.hasOwnProperty(F)){const e=r[F],t=r[M];if(f.boolean.isNot(e))throw new Error(ir.illegalVerifyProps(F));if(e&&f.array.isNot(t))throw new Error(ir.illegalVerifyProps(M))}return r},hr=r=>{if(r.hasOwnProperty(q)){const e=r[q];if(!f.object.isNotEmpty(e)&&!f.array.is(e))throw new Error(ir.illegalVerifyProps(q));if(f.object.isNotEmpty(e))delete e.index,r.elements=[fr(e)];else{const t=e.reduce((r,e)=>{let t;if(f.object.is(e)){if(e.hasOwnProperty(d)&&f.number.isNot(e.index))throw new Error(ir.illegalVerifyProps(d));t=e.index}if(f.array.is(e)&&f.object.is(e[0])){if(e[0].hasOwnProperty(d)&&f.number.isNot(e[0].index))throw new Error(ir.illegalVerifyProps(d));t=e[0].index}return f.number.isNot(t)&&(t="$_PROPS_ELEMENTS_DEFAULT_SCHEME_INFO"),r[t]=fr(e),r},{});r[q]=Object.keys(t).map(r=>t[r])}}return cr(r),r.hasOwnProperty(v)&&sr(r),r};class br{constructor(r){this.info=fr(r),this.verify=this.verify.bind(this)}verify(r,e,t){try{return nr(r,this.info,t),!0}catch(r){if(e)throw r;return!1}}}exports.Pattern=w,exports.Schema=br,exports.Type=f,exports.default=br;
